<Project>
  <Target Name="BuildInstallers" DependsOnTargets="GenerateTargzs;GenerateRpms;GenerateDebs;GenerateRelabledInstallers" />

  <Target Name="_EnsureInstallerPrerequisites">
    <MakeDir Directories="$(_InstallersOutputDir)" />

    <!-- Check Docker server OS -->
    <Exec Command="docker version -f &quot;{{.Server.Os}}&quot;" StandardOutputImportance="Normal" ConsoleToMSBuild="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="DockerHostOS" />
    </Exec>

    <Error Text="Docker host must be using Linux containers." Condition="'$(DockerHostOS)' != 'linux'"/>
    <Error Text="Linux archive not found at $(SFLinuxArchiveFilePath)." Condition="!Exists('$(SFLinuxArchiveFilePath)')" />
  </Target>

  <Target Name="_DownloadInstallers">
    <!-- Download dotnet installers -->
    <MakeDir Directories="$(_InstallerSource)" />
    <!--
      Note: KOREBUILD_DOTNET_FEED_CREDENTIAL is intentionally NOT an MSBuild variable.
      MSBuild doesn't to the substitution correctly because the string contains %,
      so we'll let bash do it instead.
    -->
    <Exec Command="curl --fail -sSL &quot;$(RuntimeTargzLink)$KOREBUILD_DOTNET_FEED_CREDENTIAL&quot; -o $(_InstallerSource)$(DotnetRuntimeInstallerArchiveName)" />
  </Target>

  <Target Name="GenerateTargzs" DependsOnTargets="_EnsureInstallerPrerequisites;_DownloadInstallers">
    <PropertyGroup>
      <HostingArchiveName>$(HostingInstallerName)-$(PackageVersion)-linux-x64.tar.gz</HostingArchiveName>
    </PropertyGroup>

    <!-- Clear working directory -->
    <RemoveDir Directories="$(_WorkRoot)" />
    <MakeDir Directories="$(_WorkRoot)" />

    <!-- Create layout: Aspnet Hosting Bundle -->
    <Exec Command="tar -xzf $(SFLinuxArchiveFilePath) -C $(_WorkRoot)" />
    <Exec Command="tar -xzf $(_InstallerSource)$(DotnetRuntimeInstallerArchiveName) -C $(_WorkRoot)" />

    <!-- Create Aspnet Hosting Bundle tar.gz -->
    <Exec Command="tar -czf $(_InstallersOutputDir)$(HostingArchiveName) -C $(_WorkRoot) ."/>
  </Target>

  <Target Name="_BuildDockerImage">
    <Exec Command="docker build --build-arg USER_ID=%24(id -u) -t docker-image-$(Image) $(Image)" WorkingDirectory="$(_DockerDir)" />
  </Target>

  <Target Name="_RemoveDockerImage">
    <Exec Command="docker rmi docker-image-$(Image)" />
  </Target>

  <Target Name="_GenerateRpm">
    <!-- Clear working directory -->
    <RemoveDir Directories="$(_WorkRoot)" />
    <MakeDir Directories="$(_WorkRoot)" />

    <!-- Create layout: Extract archive if given -->
    <MakeDir Directories="$(_WorkRoot)package_root\" />
    <Exec Command="tar -xzf $(SFArchive) -C $(_WorkRoot)package_root\" Condition="'$(SFArchive)'!=''" />

    <!-- Create layout: Place changelog -->
    <Copy
      SourceFiles="$(_PackagingDir)changelog"
      DestinationFiles="$(_WorkRoot)templates/changelog"
      OverwriteReadOnlyFiles="True"
      SkipUnchangedFiles="False"
      UseHardlinksIfPossible="False" />

    <ItemGroup>
      <ChangelogItems Include="DATE" Replacement="$([System.DateTime]::UtcNow.ToString(ddd MMM dd yyyy))" />
      <ChangelogItems Include="MAINTAINER_NAME" Replacement="$(RPMMaintainerName)" />
      <ChangelogItems Include="MAINTAINER_EMAIL" Replacement="$(RPMMaintainerEmail)" />
      <ChangelogItems Include="PACKAGE_VERSION" Replacement="$(RPMVersion)" />
      <ChangelogItems Include="PACKAGE_REVISION" Replacement="$(RPMRevision)" />
    </ItemGroup>

    <!-- Update Date, Maintainer, Version, Revision and Changelog Message -->
    <RepoTasks.ReplaceInFile Filename="$(_WorkRoot)templates/changelog" Items="@(ChangelogItems)" />

    <!-- Update Maintainer and Summary -->
    <PropertyGroup>
      <RPMMaintainer>$(RPMMaintainerName) &lt;$(RPMMaintainerEmail)&gt;</RPMMaintainer>
      <RPMSummary>$(RPMSummary.Replace('DEB_VERSION','$(RPMVersion)'))</RPMSummary>
    </PropertyGroup>

    <!-- Run RPM -->
    <Exec Command="docker run
      --rm
      -v $(RepositoryRoot):$(_DockerRootDir)
      docker-image-$(Image)
      fpm
        --verbose
        -s dir
        -t rpm
        -n $(RPMInstallerPrefix)-$(RPMVersion)
        -p $(_DockerRootDir)artifacts/installers/$(RPMInstallerPrefix)-$(RPMVersion)-$(RPMFileSuffix)
        -v $(RPMVersion)
        --iteration $(RPMRevision)
        -a amd64
        $(RPMArguments)
        --rpm-changelog $(_DockerRootDir).w/templates/changelog
        --rpm-summary &quot;$(RPMSummary)&quot;
        --description &quot;$(RPMDescription)&quot;
        --maintainer &quot;$(RPMMaintainer)&quot;
        --vendor &quot;$(RPMVendor)&quot;
        --license &quot;$(RPMLicense)&quot;
        --url &quot;$(RPMHomepage)&quot;
        $(_DockerRootDir).w/package_root/=&quot;$(RPMInstallRoot)/&quot;" />
  </Target>

  <Target Name="GenerateRpms" DependsOnTargets="_EnsureInstallerPrerequisites">
     <PropertyGroup>
      <Image>rhel.7</Image>
      <RPMVendor>.NET Foundation</RPMVendor>
      <RHInstallRoot>/opt/rh/rh-dotnet20/root/usr/lib64/dotnet</RHInstallRoot>
    </PropertyGroup>

    <!-- Build Docker Image -->
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_BuildDockerImage" Properties="Image=$(Image)" />

    <ItemGroup>
      <RPMHostingDependencies Include="$(SFInstallerName)-$(PackageVersion)" Version="$(PackageVersion)" />
      <RPMHostingDependencies Include="$(DotnetRuntimeInstallerName)" Version="$(CoreSetupPackageVersion)" />
      <RPMSFDependencies Include="aspnetcore-store-2.0.3" Version="2.0.3" />
      <RHSFDirectories Include="$(RHInstallRoot)/shared" />
      <GenericSFDirectories Include="$(InstallRoot)/shared" />
    </ItemGroup>

    <PropertyGroup>
      <HostingFPMArguments>@(RPMHostingDependencies->' -d &quot;%(Identity) &gt;= %(Version)&quot;', ' ')</HostingFPMArguments>
      <SFFPMArguments>@(RPMSFDependencies->' -d &quot;%(Identity) &gt;= %(Version)&quot;', ' ')</SFFPMArguments>
      <RHSFArguments>@(RHSFDirectories->' --directories &quot;%(FullPath)&quot;', ' ')</RHSFArguments>
      <GenericSFArguments>@(GenericSFDirectories->' --directories &quot;%(FullPath)&quot;', ' ')</GenericSFArguments>

      <CommonArguments>Image=$(Image);RPMVendor=$(RPMVendor);RPMVersion=$(PackageVersion)</CommonArguments>
      <CommonArguments>$(CommonArguments);RPMMaintainerName=$(MaintainerName);RPMMaintainerEmail=$(MaintainerEmail)</CommonArguments>
      <CommonArguments>$(CommonArguments);RPMHomepage=$(Homepage);RPMRevision=$(PackageRevision)</CommonArguments>
      <CommonArguments>$(CommonArguments);RPMLicense=$(LicenseType)</CommonArguments>
      <CommonGenericArguments>RPMFileSuffix=rhel.7-x64.rpm;RPMInstallRoot=$(InstallRoot)</CommonGenericArguments>
      <CommonRHArguments>RPMFileSuffix=rh.rhel.7-x64.rpm;RPMInstallRoot=$(RHInstallRoot)</CommonRHArguments>

      <CommonSFArguments>RPMInstallerPrefix=$(SFInstallerName);SFArchive=$(SFLinuxArchiveFilePath);$(SFFPMArguments)</CommonSFArguments>
      <CommonSFArguments>$(CommonSFArguments);RPMSummary=$(SFSummary);RPMDescription=$(SFDescription)</CommonSFArguments>

      <CommonHostingArguments>RPMInstallerPrefix=$(HostingInstallerName);RPMArguments=$(HostingFPMArguments)</CommonHostingArguments>
      <CommonHostingArguments>$(CommonHostingArguments);RPMSummary=$(HostingSummary);RPMDescription=$(HostingDescription)</CommonHostingArguments>

      <SF_RPM_Arguments>$(CommonArguments);$(CommonGenericArguments);$(CommonSFArguments);RPMArguments=$(GenericSFArguments)</SF_RPM_Arguments>
      <Hosting_RPM_Arguments>$(CommonArguments);$(CommonGenericArguments);$(CommonHostingArguments)</Hosting_RPM_Arguments>
      <SF_RPM_RedHat_Arguments>$(CommonArguments);$(CommonRHArguments);$(CommonSFArguments);RPMArguments=$(RHSFArguments)</SF_RPM_RedHat_Arguments>
      <Hosting_RPM_RedHat_Arguments>$(CommonArguments);$(CommonRHArguments);$(CommonHostingArguments)</Hosting_RPM_RedHat_Arguments>
    </PropertyGroup>

    <!-- General shared framework -->
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_GenerateRpm" Properties="$(SF_RPM_Arguments)" />
    <!-- General hosting bundle -->
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_GenerateRpm" Properties="$(Hosting_RPM_RedHat_Arguments)" />

    <!-- RH shared framework -->
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_GenerateRpm" Properties="$(SF_RPM_RedHat_Arguments)" />
    <!-- RH hosting bundle -->
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_GenerateRpm" Properties="$(Hosting_RPM_Arguments)" />

    <!-- Remove Docker Image to save disk space -->
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_RemoveDockerImage" Properties="Image=$(Image)" />
  </Target>

  <Target Name="RunDebTool">
    <!-- Install dotnet-deb tool -->
    <MSBuild Projects="$(_DebToolDir)dotnet-deb-tool-consumer.csproj" Targets="Restore" />

    <!-- Build deb package -->
    <Exec
      Command="dotnet deb-tool -i $(_WorkLayoutDir) -o $(_WorkOutputDir) -n $(INSTALLER_NAME) -v $(INSTALLER_VERSION)"
      WorkingDirectory="$(_DebToolDir)" />
  </Target>

  <Target Name="_GenerateDeb">
    <!-- Create layout: Clear work directory -->
    <RemoveDir Directories="$(_WorkRoot)" />
    <MakeDir Directories="$(_WorkRoot)" />

    <!-- Create layout: Extract archive if given -->
    <MakeDir Directories="$(_WorkLayoutDir)package_root\" />
    <Exec Command="tar -xzf $(SFArchive) -C $(_WorkLayoutDir)package_root/" Condition="'$(SFArchive)'!=''" />

    <!-- Create layout: Generate and Place debian_config.json -->
    <Copy
      SourceFiles="$(DebConfigFile)"
      DestinationFiles="$(_WorkLayoutDir)debian_config.json"
      OverwriteReadOnlyFiles="True"
      SkipUnchangedFiles="False"
      UseHardlinksIfPossible="False" />

    <ItemGroup>
      <DebConfigItems Include="MAINTAINER_NAME" Replacement="$(MaintainerName)" />
      <DebConfigItems Include="MAINTAINER_EMAIL" Replacement="$(MaintainerEmail)" />
      <DebConfigItems Include="HOMEPAGE" Replacement="$(Homepage)" />
      <DebConfigItems Include="INSTALL_ROOT" Replacement="$(InstallRoot)" />
      <DebConfigItems Include="PACKAGE_NAME" Replacement="$(DebPrefix)" />
      <DebConfigItems Include="PACKAGE_REVISION" Replacement="$(PackageRevision)" />
      <DebConfigItems Include="LICENSE_TYPE" Replacement="$(LicenseType)" />
      <DebConfigItems Include="SHORT_DESCRIPTION" Replacement="$(DebSummary)" />
      <DebConfigItems Include="LONG_DESCRIPTION" Replacement="$(DebDescription)" />
      <DebConfigItems Include="DEBIAN_DEPENDENCIES" Replacement="$(DebDependencies)" />
    </ItemGroup>

    <!-- Update versions -->
    <RepoTasks.ReplaceInFile Filename="$(_WorkLayoutDir)debian_config.json" Items="@(DebConfigItems)" />

    <!-- Build SF and Hosting Bundle Deb package -->

    <!--
      Note: KOREBUILD_DOTNET_FEED_CREDENTIAL is intentionally NOT an MSBuild variable.
      MSBuild doesn't to the substitution correctly because the string contains %,
      so we'll let bash do it instead.
    -->

    <Exec Command="docker run
      --rm
      -v $(RepositoryRoot):$(_DockerRootDir)
      -e DOTNET_SKIP_FIRST_TIME_EXPERIENCE=true
      -e INSTALLER_NAME=$(DebPrefix)-$(DebVersion)
      -e INSTALLER_VERSION=$(DebVersion)
      -e 'KOREBUILD_DOTNET_VERSION=$(KOREBUILD_DOTNET_VERSION)'
      -e 'KOREBUILD_DOTNET_SHARED_RUNTIME_VERSION=$(KOREBUILD_DOTNET_SHARED_RUNTIME_VERSION)'
      -e 'KOREBUILD_DOTNET_FEED_CDN=$(KOREBUILD_DOTNET_FEED_CDN)'
      -e 'KOREBUILD_DOTNET_FEED_UNCACHED=$(KOREBUILD_DOTNET_FEED_UNCACHED)'
      -e &quot;KOREBUILD_DOTNET_FEED_CREDENTIAL=$KOREBUILD_DOTNET_FEED_CREDENTIAL&quot;
      docker-image-$(Image)
      ./build.sh /t:RunDebTool"
      ContinueOnError="WarnAndContinue" />

    <!-- Copy SF and Hosting Bundle packages to output -->
    <ItemGroup>
      <GeneratedDebFiles Include="$(_WorkOutputDir)/*.deb" />
    </ItemGroup>

    <Error Text="@(GeneratedDebFiles->Count()) deb installer files generated." Condition="'@(GeneratedDebFiles->Count())' != 1" />

    <Copy
      DestinationFiles="$(_InstallersOutputDir)$(DebPrefix)-$(DebVersion)-$(Image)-x64.deb"
      SourceFiles="@(GeneratedDebFiles)"
      OverwriteReadOnlyFiles="True"
      SkipUnchangedFiles="False"
      UseHardlinksIfPossible="False" />
  </Target>

  <Target Name="_GenerateDebOnPlatform">
    <!-- Build Docker Image -->
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_BuildDockerImage" Properties="Image=$(Image)" />

    <ItemGroup>
      <_DebSFDependencies Include="aspnetcore-store-2.0.3"/>
      <_DebHostingDependencies Include="$(DotnetRuntimeInstallerName)"/>
      <_DebHostingDependencies Include="$(SFInstallerName)-$(Version)"/>
    </ItemGroup>

    <PropertyGroup>
      <DebSFDependencies>@(_DebSFDependencies->'"%(Identity)": {}', ', ')</DebSFDependencies>
      <DebHostingDependencies>@(_DebHostingDependencies->'"%(Identity)": {}', ', ')</DebHostingDependencies>

      <CommonProps>Image=$(Image);DebVersion=$(Version)</CommonProps>
      <DebSFProps>DebPrefix=$(SFInstallerName);DebSummary=$(SFSummary);DebDescription=$(SFDescription)</DebSFProps>
      <DebSFProps>$(DebSFProps);DebDependencies=$(DebSFDependencies);SFArchive=$(SFLinuxArchiveFilePath)</DebSFProps>
      <DebHostingProps>DebPrefix=$(HostingInstallerName);DebSummary=$(HostingSummary);DebDescription=$(HostingDescription)</DebHostingProps>
      <DebHostingProps>$(DebHostingProps);DebDependencies=$(DebHostingDependencies)</DebHostingProps>
    </PropertyGroup>

    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_GenerateDeb" Properties="$(CommonProps);$(DebSFProps)" />
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_GenerateDeb" Properties="$(CommonProps);$(DebHostingProps)" />

    <!-- Remove Docker Image to save disk space -->
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_RemoveDockerImage" Properties="Image=$(Image)" />
  </Target>

  <Target Name="GenerateDebs" DependsOnTargets="_EnsureInstallerPrerequisites">
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_GenerateDebOnPlatform" Properties="Version=$(Version);Image=debian.8" />
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_GenerateDebOnPlatform" Properties="Version=$(Version);Image=ubuntu.14.04" />
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_GenerateDebOnPlatform" Properties="Version=$(Version);Image=ubuntu.16.04" />
  </Target>

  <Target Name="_GenerateRelabledInstaller">
    <ItemGroup>
      <Installers Include="$(_InstallersOutputDir)*$(Source)*" />
    </ItemGroup>

    <Copy
      SourceFiles="%(Installers.FullPath)"
      DestinationFiles="$([System.String]::Copy('%(Installers.FullPath)').Replace('$(Source)','$(Target)'))"
      OverwriteReadOnlyFiles="True"
      SkipUnchangedFiles="False"
      UseHardlinksIfPossible="False" />
  </Target>

  <Target Name="GenerateRelabledInstallers">
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_GenerateRelabledInstaller" Properties="Source=debian.8;Target=debian.9" />
    <MSBuild Projects="$(MSBuildProjectFullPath)" Targets="_GenerateRelabledInstaller" Properties="Source=ubuntu.16.04;Target=ubuntu.17.04" />
  </Target>
</Project>
